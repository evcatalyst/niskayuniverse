<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Line Markers - PMTiles Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100vw; height: 100vh; }

    .service-tooltip {
      font-family: Arial, sans-serif;
      max-width: 250px;
    }

    .service-tooltip h4 {
      margin: 0 0 8px 0;
      color: #333;
    }

    .service-tooltip p {
      margin: 4px 0;
      font-size: 14px;
    }

    .search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 250px;
    }

    .search-container input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
    }

    .search-results {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 5px;
    }

    .search-result {
      padding: 5px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .search-result:hover {
      background-color: #f5f5f5;
    }

    .search-result:last-child {
      border-bottom: none;
    }

    #ph-toggle {
      margin-top: 10px;
      width: 100%;
      padding: 8px;
      background: #4ECDC4;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    #file-notice {
      display: none;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 3px;
      font-size: 12px;
      color: #856404;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="search-container">
    <div id="file-notice">
      Running from local file. Showing demo data only. Use a web server for full functionality.
    </div>
    <input type="text" id="search-input" placeholder="Search addresses...">
    <div class="search-results" id="search-results"></div>
    <button id="ph-toggle">
      Toggle pH Reports
    </button>
  </div>

  <script>
    let map;
    let markers = [];
    let markerLayer;
    let phMarkers = [];
    let phLayer;
    let searchInput;
    let searchResults;
    let showPhOverlay = false;

    function initMap() {
      console.log('Initializing map...');

      // Show notice if running from file://
      if (window.location.protocol === 'file:') {
        document.getElementById('file-notice').style.display = 'block';
      }

      map = L.map('map').setView([42.78, -73.85], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // Initialize search
      searchInput = document.getElementById('search-input');
      searchResults = document.getElementById('search-results');

      searchInput.addEventListener('input', handleSearch);
      searchInput.addEventListener('keydown', handleSearchKeydown);

      // Initialize pH toggle
      document.getElementById('ph-toggle').addEventListener('click', togglePhOverlay);

      // Close search results when clicking on map
      map.on('click', () => {
        searchResults.innerHTML = '';
      });

      loadMarkers();
      loadPhData();
    }

    function loadMarkers() {
      console.log('Loading markers...');

      // Check if we're running from file:// protocol
      if (window.location.protocol === 'file:') {
        console.log('Running from file:// protocol, showing demo data');
        // Show a sample marker for demo purposes
        markers = [
          {
            id: "demo_1",
            address: "123 Main Street",
            town: "Niskayuna",
            zip: "12309",
            private_type: "copper",
            public_type: "copper",
            verified: true,
            confidence: 1.0,
            position: [-73.85, 42.78]
          },
          {
            id: "demo_2",
            address: "456 Oak Avenue",
            town: "Niskayuna",
            zip: "12309",
            private_type: "lead",
            public_type: "copper",
            verified: false,
            confidence: 0.8,
            position: [-73.86, 42.79]
          },
          {
            id: "demo_3",
            address: "789 Pine Road",
            town: "Niskayuna",
            zip: "12309",
            private_type: "plastic",
            public_type: "plastic",
            verified: true,
            confidence: 0.95,
            position: [-73.84, 42.77]
          }
        ];
        updateMarkers();
        return;
      }

      console.log('Loading markers from ../data/markers.json');
      fetch('../data/markers.json')
        .then(response => {
          console.log('Fetch response:', response);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Loaded data:', data.length, 'markers');
          markers = data.filter(m => m.position && m.position.length === 2);
          console.log('Filtered markers:', markers.length);
          updateMarkers();
        })
        .catch(error => {
          console.error('Error loading markers:', error);
          // Fallback: show demo data
          console.log('Showing demo data due to error');
          markers = [
            {
              id: "demo_1",
              address: "123 Main Street",
              town: "Niskayuna",
              zip: "12309",
              private_type: "copper",
              public_type: "copper",
              verified: true,
              confidence: 1.0,
              position: [-73.85, 42.78]
            },
            {
              id: "demo_2",
              address: "456 Oak Avenue",
              town: "Niskayuna",
              zip: "12309",
              private_type: "lead",
              public_type: "copper",
              verified: false,
              confidence: 0.8,
              position: [-73.86, 42.79]
            },
            {
              id: "demo_3",
              address: "789 Pine Road",
              town: "Niskayuna",
              zip: "12309",
              private_type: "plastic",
              public_type: "plastic",
              verified: true,
              confidence: 0.95,
              position: [-73.84, 42.77]
            }
          ];
          updateMarkers();
        });
    }

    function loadPhData() {
      console.log('Loading pH data...');

      // Check if we're running from file:// protocol
      if (window.location.protocol === 'file:') {
        console.log('Running from file:// protocol, skipping pH data');
        return;
      }

      fetch('../../ph_reports_template.csv')
        .then(response => response.text())
        .then(csvText => {
          phMarkers = parsePhCsv(csvText);
          console.log(`Loaded ${phMarkers.length} pH reports`);
          updatePhLayer();
        })
        .catch(error => console.error('Error loading pH data:', error));
    }

    function parsePhCsv(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines[0].split(',');

      return lines.slice(1)
        .map(line => {
          const values = line.split(',');
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = values[index];
          });
          return obj;
        })
        .filter(row => row.lat && row.lng && row.ph_value)
        .map(row => ({
          ...row,
          lat: parseFloat(row.lat),
          lng: parseFloat(row.lng),
          ph_value: parseFloat(row.ph_value)
        }));
    }

    function updateMarkers() {
      // Clear existing markers
      if (markerLayer) {
        map.removeLayer(markerLayer);
      }

      const zoom = map.getZoom();
      const visibleMarkers = markers.filter(m => shouldShowMarker(m, zoom));

      console.log(`Showing ${visibleMarkers.length} markers at zoom ${zoom}`);

      markerLayer = L.layerGroup(
        visibleMarkers.map(marker => createMarker(marker, zoom))
      ).addTo(map);
    }

    function updatePhLayer() {
      // Clear existing pH layer
      if (phLayer) {
        map.removeLayer(phLayer);
      }

      if (!showPhOverlay || phMarkers.length === 0) return;

      phLayer = L.layerGroup(
        phMarkers.map(phReport => createPhMarker(phReport))
      ).addTo(map);
    }

    function shouldShowMarker(marker, zoom) {
      // Only show markers that are geocoded
      if (!marker.position) return false;

      // At low zoom, show a sample of markers to avoid overcrowding
      if (zoom < 14) {
        // Show every 10th marker at low zoom
        return marker.id % 10 === 0;
      }

      return true;
    }

    function createMarker(marker, zoom) {
      const style = getMarkerStyle(marker, zoom);

      const leafletMarker = L.circleMarker(marker.position, style)
        .bindPopup(createTooltip(marker));

      // Store reference to original marker data
      leafletMarker.markerData = marker;

      return leafletMarker;
    }

    function createPhMarker(phReport) {
      const style = getPhMarkerStyle(phReport);

      return L.circleMarker([phReport.lat, phReport.lng], style)
        .bindPopup(createPhTooltip(phReport));
    }

    function getMarkerStyle(marker, zoom) {
      const material = marker.private_type || 'unknown';
      const side = 'unknown'; // Not available in current data
      const verified = marker.verified;

      let style = {
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      };

      // Color mapping based on material
      const colorMap = {
        'lead': '#FF6B6B',
        'copper': '#4ECDC4',
        'galvanized': '#45B7D1',
        'plastic': '#96CEB4',
        'unknown': '#D4A574'
      };

      style.color = colorMap[material] || colorMap.unknown;

      // Zoom-based styling
      if (zoom <= 14) {
        // Halo style - larger, semi-transparent
        style.radius = 8;
        style.fillOpacity = 0.4;
        style.weight = 1;
      } else if (zoom <= 16) {
        // Nested style - medium
        style.radius = 6;
        style.fillOpacity = 0.7;
        style.weight = 2;
      } else {
        // Split style - small, side-specific colors
        style.radius = 4;
        style.fillOpacity = 1.0;
        style.weight = 1;

        // For high zoom, use different colors for public vs private
        if (marker.public_type !== marker.private_type) {
          style.color = '#FF8C42'; // Orange for mixed types
        }
      }

      return style;
    }

    function getPhMarkerStyle(phReport) {
      const ph = phReport.ph_value;

      // pH color coding (red for acidic, green for neutral, blue for basic)
      let color;
      if (ph < 6.5) {
        color = '#FF6B6B'; // Red for acidic
      } else if (ph <= 8.5) {
        color = '#4ECDC4'; // Green for neutral
      } else {
        color = '#45B7D1'; // Blue for basic
      }

      return {
        color: color,
        fillColor: color,
        fillOpacity: 0.8,
        radius: 8,
        weight: 2
      };
    }

    function createTooltip(marker) {
      const material = marker.private_type || 'Unknown';
      const publicType = marker.public_type || 'Unknown';
      const address = marker.address || 'Unknown Address';
      const verified = marker.verified ? 'Yes' : 'No';

      return `
        <div class="service-tooltip">
          <h4>Service Line</h4>
          <p><strong>Address:</strong> ${address}</p>
          <p><strong>Private Material:</strong> ${material}</p>
          <p><strong>Public Material:</strong> ${publicType}</p>
          <p><strong>Verified:</strong> ${verified}</p>
          <p><strong>Confidence:</strong> ${marker.confidence || 'N/A'}</p>
        </div>
      `;
    }

    function createPhTooltip(phReport) {
      return `
        <div class="service-tooltip">
          <h4>pH Test Report</h4>
          <p><strong>Address:</strong> ${phReport['street address']}</p>
          <p><strong>pH Value:</strong> ${phReport.ph_value}</p>
          <p><strong>Sample Type:</strong> ${phReport.sample_type}</p>
          <p><strong>Temperature:</strong> ${phReport.sample_temp_c}Â°C</p>
          <p><strong>Chlorine:</strong> ${phReport.residual_chlorine_mg_l} mg/L</p>
          <p><strong>Date:</strong> ${new Date(phReport.timestamp_iso).toLocaleDateString()}</p>
        </div>
      `;
    }

    function handleSearch() {
      const query = searchInput.value.toLowerCase().trim();
      searchResults.innerHTML = '';

      if (query.length < 2) return;

      const matches = markers
        .filter(marker => marker.address && marker.address.toLowerCase().includes(query))
        .slice(0, 10); // Limit to 10 results

      matches.forEach(marker => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'search-result';
        resultDiv.textContent = marker.address;
        resultDiv.addEventListener('click', () => selectSearchResult(marker));
        searchResults.appendChild(resultDiv);
      });
    }

    function handleSearchKeydown(e) {
      if (e.key === 'Enter') {
        const firstResult = searchResults.querySelector('.search-result');
        if (firstResult) {
          firstResult.click();
        }
      } else if (e.key === 'Escape') {
        searchInput.value = '';
        searchResults.innerHTML = '';
        searchInput.blur();
      }
    }

    function selectSearchResult(marker) {
      // Clear search
      searchInput.value = marker.address;
      searchResults.innerHTML = '';

      // Pan to marker
      map.setView(marker.position, 18);

      // Find and open popup for this marker
      if (markerLayer) {
        markerLayer.eachLayer(layer => {
          if (layer.markerData && layer.markerData.id === marker.id) {
            layer.openPopup();
            return false; // Stop iteration
          }
        });
      }
    }

    function togglePhOverlay() {
      showPhOverlay = !showPhOverlay;
      updatePhLayer();

      const button = document.getElementById('ph-toggle');
      button.style.background = showPhOverlay ? '#45B7D1' : '#4ECDC4';
      button.textContent = showPhOverlay ? 'Hide pH Reports' : 'Show pH Reports';
    }

    // Update markers when zoom changes
    map.on('zoomend', () => {
      updateMarkers();
      updatePhLayer();
    });

    initMap();
  </script>
</body>
</html>